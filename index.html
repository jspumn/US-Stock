<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Tech æŠ•è³‡åˆ†æç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .strong-buy { animation: pulse-green 2s infinite; border: 2px solid #22c55e; }
        .bg-card { background: #111827; border: 1px solid #1f2937; cursor: pointer; transition: 0.3s; }
        .bg-card:hover { border-color: #3b82f6; transform: translateY(-3px); }
    </style>
</head>
<body class="bg-black text-gray-200 font-sans min-h-screen">
    <div id="app">
        
        <div v-if="!isUnlocked" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center">
            <h1 class="text-2xl font-black text-white tracking-[0.5em] uppercase mb-4">Security Lock</h1>
            <input type="password" maxlength="4" v-model="passInput" @input="checkPass" placeholder="â€¢â€¢â€¢â€¢" class="bg-black border-2 border-gray-700 w-64 py-5 rounded-3xl text-center text-white text-3xl">
            <p v-if="errorMsg" class="mt-4 text-red-500 font-mono text-sm">{{ errorMsg }}</p>
        </div>

        <template v-if="isUnlocked">
            <div class="max-w-7xl mx-auto px-6 py-10 animate__animated animate__fadeIn">
                <header class="flex justify-between items-end mb-12 border-b border-gray-800 pb-8">
                    <h1 class="text-4xl font-black text-white uppercase tracking-tighter">Market <span class="text-blue-500">Analysis</span></h1>
                    <div class="text-right">
                        <button @click="resetAiKey" class="text-[10px] text-blue-500 hover:underline mb-2 block ml-auto uppercase tracking-widest">Update AI Key</button>
                        <div class="px-4 py-1 bg-gray-900 rounded-full border border-gray-800 text-blue-400 font-mono text-sm">Next Update: {{ countdown }}s</div>
                    </div>
                </header>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-20">
                    <div v-for="s in stocks" :key="s.symbol" @click="openModal(s)" :class="['bg-card p-6 rounded-2xl', s.isBuy ? 'strong-buy' : '']">
                        <h3 class="text-2xl font-black text-white">{{ s.symbol }}</h3>
                        <div class="text-3xl font-mono text-white mt-2">${{ s.price }}</div>
                        <div class="mt-8 pt-4 border-t border-gray-800 text-[10px] uppercase font-bold text-gray-500">52W Low Dist: <span :class="s.isBuy?'text-green-400':''">{{ s.distLow }}%</span></div>
                    </div>
                </div>

                <div class="fixed bottom-6 right-6 z-50">
                    <div v-if="chatOpen" class="w-80 md:w-96 bg-gray-900 border border-gray-700 rounded-3xl shadow-2xl flex flex-col overflow-hidden animate__animated animate__fadeInUp">
                        <div class="p-4 bg-blue-600 text-white font-bold flex justify-between items-center">
                            <span>âœ¨ AI Advisor (Gemini)</span>
                            <button @click="chatOpen = false">âœ•</button>
                        </div>
                        <div class="h-[400px] p-4 overflow-y-auto space-y-4 bg-gray-950 text-sm" id="chatbox">
                            <div v-for="msg in chatHistory" :class="['p-3 rounded-2xl max-w-[90%]', msg.role === 'user' ? 'bg-blue-900 ml-auto' : 'bg-gray-800']">
                                <div v-html="msg.text"></div>
                            </div>
                            <div v-if="isTyping" class="text-blue-500 text-xs animate-pulse font-mono tracking-widest uppercase">Analyzing Data...</div>
                        </div>
                        <div class="p-4 bg-gray-900 border-t border-gray-800 flex gap-2">
                            <input v-model="userInput" @keyup.enter="askGemini" type="text" placeholder="è©¢å•åˆ†æ..." class="flex-1 bg-black border border-gray-700 rounded-full px-4 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                            <button @click="askGemini" class="bg-blue-600 p-2 rounded-full font-bold text-white">âœ</button>
                        </div>
                    </div>
                    <button v-else @click="chatOpen = true" class="w-16 h-16 bg-blue-600 rounded-full shadow-2xl flex items-center justify-center text-3xl">ğŸ¤–</button>
                </div>
            </div>

            <div v-if="selectedStock" class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/95" @click.self="selectedStock = null">
                <div class="bg-gray-900 w-full max-w-6xl h-[85vh] rounded-3xl overflow-hidden border border-gray-700 flex flex-col">
                    <div id="tv-chart" class="flex-1"></div>
                </div>
            </div>
        </template>
    </div>

    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const { createApp, nextTick } = Vue;

        createApp({
            data() {
                return {
                    isUnlocked: false, passInput: '', errorMsg: '', correctPass: '0923',
                    FINNHUB_KEY: 'd65qv59r01qiish0oeo0d65qv59r01qiish0oeog',
                    stocks: [
                        { symbol: 'AAPL', price: '0', change: 0, distLow: 0, isBuy: false },
                        { symbol: 'MSFT', price: '0', change: 0, distLow: 0, isBuy: false },
                        { symbol: 'GOOGL', price: '0', change: 0, distLow: 0, isBuy: false },
                        { symbol: 'AMZN', price: '0', change: 0, distLow: 0, isBuy: false },
                        { symbol: 'NVDA', price: '0', change: 0, distLow: 0, isBuy: false },
                        { symbol: 'META', price: '0', change: 0, distLow: 0, isBuy: false },
                        { symbol: 'TSLA', price: '0', change: 0, distLow: 0, isBuy: false },
                        { symbol: 'AVGO', price: '0', change: 0, distLow: 0, isBuy: false },
                        { symbol: 'TSM', price: '0', change: 0, distLow: 0, isBuy: false },
                        { symbol: 'ORCL', price: '0', change: 0, distLow: 0, isBuy: false }
                    ],
                    countdown: 60, chatOpen: false, userInput: '', isTyping: false,
                    chatHistory: [{ role: 'model', text: 'æˆ‘æ˜¯ AIï¼Œå·²è®€å–å³æ™‚è‚¡åƒ¹ã€‚è«‹æå‡ºæ‚¨çš„åˆ†æéœ€æ±‚ã€‚' }],
                    selectedStock: null
                }
            },
            methods: {
                checkPass() { if (this.passInput === this.correctPass) { this.isUnlocked = true; this.start(); } },
                resetAiKey() { localStorage.removeItem('local_gemini_key'); alert('AI Key å·²æ¸…é™¤ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ã€‚'); },
                start() { this.update(); setInterval(() => { if (this.countdown <= 1) { this.update(); this.countdown = 60; } else this.countdown--; }, 1000); },
                async update() {
                    for (let s of this.stocks) {
                        try {
                            const r1 = await fetch(`https://finnhub.io/api/v1/quote?symbol=${s.symbol}&token=${this.FINNHUB_KEY}`);
                            const d1 = await r1.json();
                            const r2 = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${s.symbol}&metric=all&token=${this.FINNHUB_KEY}`);
                            const d2 = await r2.json();
                            s.price = d1.c.toFixed(2);
                            s.distLow = (((d1.c - d2.metric['52WeekLow']) / d2.metric['52WeekLow']) * 100).toFixed(1);
                            s.isBuy = s.distLow < 5;
                        } catch (e) { console.error(e); }
                    }
                },
                async askGemini() {
                    if (!this.userInput) return;
                    let apiKey = localStorage.getItem('local_gemini_key');
                    if (!apiKey) {
                        apiKey = prompt("è«‹è¼¸å…¥æ‚¨çš„ Gemini API Keyï¼š");
                        if (apiKey) localStorage.setItem('local_gemini_key', apiKey);
                        else return;
                    }
                    const text = this.userInput;
                    this.chatHistory.push({ role: 'user', text });
                    this.userInput = '';
                    this.isTyping = true;
                    
                    const context = this.stocks.map(s => `${s.symbol}: $${s.price}`).join(', ');
                    
                    try {
                        const genAI = new GoogleGenerativeAI(apiKey);
                        // å˜—è©¦ä½¿ç”¨ flash-latest æ¨¡å‹
                        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest" });
                        const result = await model.generateContent(`å°ˆæ¥­ç¾è‚¡é¡§å•ã€‚æ•¸æ“šï¼š[${context}]ã€‚å›ç­”ï¼š${text}`);
                        this.chatHistory.push({ role: 'model', text: result.response.text().replace(/\n/g, '<br>') });
                    } catch (e) {
                        // å®¹éŒ¯é‚è¼¯ï¼šå¦‚æœ Flash å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ Pro ç‰ˆæœ¬
                        try {
                            const genAI = new GoogleGenerativeAI(apiKey);
                            const model = genAI.getGenerativeModel({ model: "gemini-1.5-pro" });
                            const result = await model.generateContent(`æ•¸æ“šï¼š[${context}]ã€‚å›ç­”ï¼š${text}`);
                            this.chatHistory.push({ role: 'model', text: result.response.text().replace(/\n/g, '<br>') });
                        } catch (e2) {
                            this.chatHistory.push({ role: 'model', text: `âŒ é€£ç·šå¤±æ•—: ${e2.message}ã€‚è«‹ç¢ºèªæ‚¨çš„ API Key æ˜¯å¦å·²åœ¨ AI Studio å•Ÿç”¨ï¼Œæˆ–å˜—è©¦æ›´æ›ç¶²è·¯ç’°å¢ƒã€‚` });
                            localStorage.removeItem('local_gemini_key');
                        }
                    } finally {
                        this.isTyping = false;
                        nextTick(() => { const b = document.getElementById('chatbox'); b.scrollTop = b.scrollHeight; });
                    }
                },
                async openModal(s) {
                    this.selectedStock = s;
                    await nextTick();
                    new TradingView.widget({ "autosize": true, "symbol": s.symbol, "theme": "dark", "container_id": "tv-chart", "locale": "zh_TW" });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
