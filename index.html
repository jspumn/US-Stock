<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Tech Core 10 - AI æŠ•è³‡åˆ†æç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .strong-buy { animation: pulse-green 2s infinite; border: 2px solid #22c55e; }
        .bg-card { background: #111827; border: 1px solid #1f2937; cursor: pointer; transition: 0.3s; }
        .bg-card:hover { border-color: #3b82f6; transform: translateY(-3px); }
        .login-field { background: #0a0a0a; border: 1px solid #334155; color: white; text-align: center; font-size: 2rem; letter-spacing: 0.8rem; }
    </style>
</head>
<body class="bg-black text-gray-200 font-sans min-h-screen">
    <div id="app">
        
        <div v-if="!isUnlocked" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center">
            <div class="mb-8 text-center">
                <h1 class="text-2xl font-black text-white tracking-[0.5em] uppercase mb-4">Security Lock</h1>
                <div class="h-1 w-24 bg-blue-600 mx-auto"></div>
            </div>
            <input type="password" maxlength="4" v-model="passInput" @input="checkPass" placeholder="â€¢â€¢â€¢â€¢" 
                   class="login-field w-64 py-5 rounded-3xl">
            <p v-if="errorMsg" class="mt-4 text-red-500 font-mono text-sm">{{ errorMsg }}</p>
        </div>

        <template v-if="isUnlocked">
            <div class="max-w-7xl mx-auto px-6 py-10 animate__animated animate__fadeIn">
                <header class="flex justify-between items-end mb-12 border-b border-gray-800 pb-8">
                    <div>
                        <h1 class="text-4xl font-black text-white tracking-tighter uppercase">Market <span class="text-blue-500">Analysis</span></h1>
                        <p class="text-gray-400 mt-2">10 æª”ç§‘æŠ€æ ¸å¿ƒç›£æ§ï¼šM7 + AVGO, TSM, ORCL</p>
                    </div>
                    <div class="text-right">
                        <button @click="resetAiKey" class="text-[10px] text-blue-500 hover:underline mb-2 block ml-auto">é‡æ–°è¨­å®š AI Key</button>
                        <button @click="logout" class="text-[10px] text-gray-600 hover:text-red-500 underline mb-2">å®‰å…¨ç™»å‡º</button>
                        <div class="px-4 py-1 bg-gray-900 rounded-full border border-gray-800 text-blue-400 font-mono text-sm">
                            Refresh in {{ countdown }}s
                        </div>
                    </div>
                </header>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-20">
                    <div v-for="s in stocks" :key="s.symbol" @click="openModal(s)"
                         :class="['bg-card p-6 rounded-2xl', s.isBuy ? 'strong-buy' : '']">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-2xl font-black text-white">{{ s.symbol }}</h3>
                            <span v-if="s.isBuy" class="bg-green-500 text-black text-[10px] font-black px-2 py-0.5 rounded">BUY</span>
                        </div>
                        <div class="text-3xl font-mono text-white">${{ s.price }}</div>
                        <div :class="['text-sm mt-1 font-bold', s.change >= 0 ? 'text-green-400' : 'text-red-400']">
                            {{ s.change >= 0 ? '+' : '' }}{{ s.change }}%
                        </div>
                        <div class="mt-8 pt-4 border-t border-gray-800 flex justify-between text-[10px] uppercase font-bold text-gray-500">
                            <span>52W Low Dist</span>
                            <span :class="s.distLow < 5 ? 'text-green-400' : 'text-gray-300'">{{ s.distLow }}%</span>
                        </div>
                    </div>
                </div>

                <div class="fixed bottom-6 right-6 z-50">
                    <div v-if="chatOpen" class="w-80 md:w-96 bg-gray-900 border border-gray-700 rounded-3xl shadow-2xl flex flex-col overflow-hidden animate__animated animate__fadeInUp">
                        <div class="p-4 bg-blue-600 text-white font-bold flex justify-between items-center">
                            <span>âœ¨ AI æŠ•è³‡é¡§å• (Gemini)</span>
                            <button @click="chatOpen = false">âœ•</button>
                        </div>
                        <div class="h-[400px] p-4 overflow-y-auto space-y-4 bg-gray-950 text-sm" id="chatbox">
                            <div v-for="msg in chatHistory" :class="['p-3 rounded-2xl max-w-[90%]', msg.role === 'user' ? 'bg-blue-900 ml-auto' : 'bg-gray-800']">
                                <div v-html="msg.text"></div>
                            </div>
                            <div v-if="isTyping" class="text-blue-500 text-xs animate-pulse">Gemini æ­£åœ¨è¨ˆç®—æ•¸æ“š...</div>
                        </div>
                        <div class="p-4 bg-gray-900 border-t border-gray-800 flex gap-2">
                            <input v-model="userInput" @keyup.enter="askGemini" type="text" placeholder="è©¢å• AI åˆ†æ..." class="flex-1 bg-black border border-gray-700 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-blue-500">
                            <button @click="askGemini" class="bg-blue-600 p-2 rounded-full font-bold text-white">âœ</button>
                        </div>
                    </div>
                    <button v-else @click="chatOpen = true" class="w-16 h-16 bg-blue-600 rounded-full shadow-2xl flex items-center justify-center text-3xl hover:scale-110 transition-transform">ğŸ¤–</button>
                </div>
            </div>

            <div v-if="selectedStock" class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/95" @click.self="selectedStock = null">
                <div class="bg-gray-900 w-full max-w-6xl h-[85vh] rounded-3xl overflow-hidden border border-gray-700 flex flex-col">
                    <div class="p-6 flex justify-between items-center">
                        <h2 class="text-2xl font-black">{{ selectedStock.symbol }} Chart</h2>
                        <button @click="selectedStock = null" class="text-3xl text-gray-500 hover:text-white">&times;</button>
                    </div>
                    <div id="tv-chart" class="flex-1"></div>
                </div>
            </div>
        </template>
    </div>

    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const { createApp, nextTick } = Vue;

        createApp({
            data() {
                return {
                    isUnlocked: false,
                    passInput: '',
                    errorMsg: '',
                    correctPass: '0923',
                    STOCK_KEY: 'd65qv59r01qiish0oeo0d65qv59r01qiish0oeog',
                    stocks: [
                        { symbol: 'AAPL', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'MSFT', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'GOOGL', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'AMZN', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'NVDA', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'META', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'TSLA', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'AVGO', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'TSM', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'ORCL', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false }
                    ],
                    countdown: 60,
                    chatOpen: false,
                    userInput: '',
                    isTyping: false,
                    chatHistory: [{ role: 'model', text: 'é©—è­‰é€šéã€‚æˆ‘æ˜¯ä½ çš„ AI é¡§å•ï¼Œéš¨æ™‚å¯ä»¥åˆ†æé€™ 10 æª”ç§‘æŠ€è‚¡æ•¸æ“šã€‚' }],
                    selectedStock: null
                }
            },
            methods: {
                checkPass() {
                    if (this.passInput.length === 4) {
                        if (this.passInput === this.correctPass) {
                            this.isUnlocked = true;
                            this.startSystem();
                        } else {
                            this.errorMsg = 'ACCESS DENIED';
                            this.passInput = '';
                            setTimeout(() => this.errorMsg = '', 2000);
                        }
                    }
                },
                logout() { this.isUnlocked = false; this.passInput = ''; },
                resetAiKey() {
                    localStorage.removeItem('user_gemini_key');
                    alert('AI Key å·²æ¸…é™¤ï¼Œä¸‹æ¬¡å°è©±æ™‚å°‡é‡æ–°è©¢å•ã€‚');
                },
                startSystem() {
                    this.updateData();
                    setInterval(() => {
                        if (this.countdown <= 1) { this.updateData(); this.countdown = 60; }
                        else { this.countdown--; }
                    }, 1000);
                },
                async updateData() {
                    for (let s of this.stocks) {
                        try {
                            const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${s.symbol}&token=${this.STOCK_KEY}`);
                            const d = await res.json();
                            const mRes = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${s.symbol}&metric=all&token=${this.STOCK_KEY}`);
                            const m = await mRes.json();
                            s.price = d.c.toFixed(2);
                            s.change = d.dp.toFixed(2);
                            s.distLow = (((d.c - m.metric['52WeekLow']) / m.metric['52WeekLow']) * 100).toFixed(1);
                            s.isBuy = s.distLow < 5;
                        } catch (e) { console.error(e); }
                    }
                },
                async askGemini() {
                    if (!this.userInput) return;
                    
                    // å¾ç€è¦½å™¨æœ¬åœ°å„²å­˜è®€å– Keyï¼Œè‹¥ç„¡å‰‡è©¢å•
                    let savedKey = localStorage.getItem('user_gemini_key');
                    if (!savedKey) {
                        savedKey = prompt("è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key (æ­¤ Key å°‡å®‰å…¨å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­)ï¼š");
                        if (savedKey) localStorage.setItem('user_gemini_key', savedKey);
                        else return;
                    }

                    const text = this.userInput;
                    this.chatHistory.push({ role: 'user', text });
                    this.userInput = '';
                    this.isTyping = true;
                    
                    const context = this.stocks.map(s => `${s.symbol}: $${s.price} (è·52Wä½é»${s.distLow}%)`).join(', ');
                    try {
                        const genAI = new GoogleGenerativeAI(savedKey);
                        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                        const result = await model.generateContent(`å°ˆæ¥­åˆ†æå¸«æ¨¡å¼ã€‚æ•¸æ“šï¼š[${context}]ã€‚å›ç­”ï¼š${text}`);
                        this.chatHistory.push({ role: 'model', text: result.response.text().replace(/\n/g, '<br>') });
                    } catch (e) { 
                        this.chatHistory.push({ role: 'model', text: `âŒ é€£ç·šå¤±æ•—: ${e.message}ã€‚è«‹ç¢ºèªæ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºã€‚` });
                        localStorage.removeItem('user_gemini_key'); // å¤±æ•—æ™‚è‡ªå‹•æ¸…é™¤ï¼Œæ–¹ä¾¿é‡æ–°è¼¸å…¥
                    } finally {
                        this.isTyping = false;
                        nextTick(() => { const b = document.getElementById('chatbox'); b.scrollTop = b.scrollHeight; });
                    }
                },
                async openModal(s) {
                    this.selectedStock = s;
                    await nextTick();
                    new TradingView.widget({
                        "autosize": true, "symbol": s.symbol, "interval": "D", "theme": "dark", "style": "1", "locale": "zh_TW", "container_id": "tv-chart"
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
