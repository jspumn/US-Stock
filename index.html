<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Tech Core 10 - AI æŠ•è³‡åˆ†æç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .strong-buy { animation: pulse-green 2s infinite; border: 2px solid #22c55e; }
        .bg-card { background: #111827; border: 1px solid #1f2937; cursor: pointer; transition: 0.3s; }
        .bg-card:hover { border-color: #3b82f6; transform: translateY(-3px); }
        .chat-container { height: 450px; display: flex; flex-direction: column; }
    </style>
</head>
<body class="bg-black text-gray-200 font-sans min-h-screen">
    <div id="app" class="max-w-7xl mx-auto px-6 py-10 relative">
        
        <header class="flex justify-between items-end mb-12">
            <div>
                <h1 class="text-4xl font-black text-white uppercase tracking-tighter">Market <span class="text-blue-500">AI Radar</span></h1>
                <p class="text-gray-400 mt-2">10 æª”æ ¸å¿ƒç§‘æŠ€è‚¡å¯¦æ™‚ç›£æ§ç³»çµ±</p>
            </div>
            <div class="text-right">
                <button @click="resetKey" class="text-[10px] text-gray-600 hover:text-gray-400 underline uppercase tracking-widest mb-2">æ›´æ–° API Key</button>
                <div class="px-3 py-1 bg-gray-900 rounded border border-gray-800 text-blue-400 font-mono text-sm">{{ countdown }}s</div>
            </div>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-20">
            <div v-for="s in stocks" :key="s.symbol" @click="openModal(s)"
                 :class="['bg-card p-6 rounded-2xl', s.isBuy ? 'strong-buy' : '']">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-2xl font-black text-white">{{ s.symbol }}</h3>
                    <span v-if="s.isBuy" class="bg-green-500 text-black text-[10px] font-black px-2 py-0.5 rounded">BUY</span>
                </div>
                <div class="text-3xl font-mono text-white">${{ s.price }}</div>
                <div :class="['text-sm mt-1 font-bold', s.change >= 0 ? 'text-green-400' : 'text-red-400']">
                    {{ s.change >= 0 ? '+' : '' }}{{ s.change }}%
                </div>
                <div class="mt-8 pt-4 border-t border-gray-800 flex justify-between text-[10px] uppercase">
                    <span class="text-gray-500 font-bold">è· 52W ä½é»</span>
                    <span :class="s.distLow < 5 ? 'text-green-400' : ''">{{ s.distLow }}%</span>
                </div>
            </div>
        </div>

        <div class="fixed bottom-6 right-6 z-50">
            <div v-if="chatOpen" class="w-80 md:w-96 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl flex flex-col overflow-hidden animate__animated animate__fadeInUp">
                <div class="p-4 bg-gradient-to-r from-blue-700 to-blue-500 text-white font-bold flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-xl">âœ¨</span> Gemini æ™ºæ…§é¡§å•
                    </div>
                    <button @click="chatOpen = false" class="hover:text-gray-200 text-xl">âœ•</button>
                </div>
                <div class="chat-container p-4 overflow-y-auto space-y-4 bg-gray-900" id="chatbox">
                    <div v-for="msg in chatHistory" :class="['p-3 rounded-xl max-w-[90%] text-sm leading-relaxed', msg.role === 'user' ? 'bg-blue-600 text-white self-end ml-auto' : 'bg-gray-800 text-gray-200 self-start']">
                        <div v-html="msg.text"></div>
                    </div>
                    <div v-if="isTyping" class="text-blue-400 italic text-[10px] animate-pulse">Gemini æ­£åœ¨æ·±å…¥åˆ†ææ•¸æ“š...</div>
                </div>
                <div class="p-4 border-t border-gray-800 bg-gray-900 flex gap-2">
                    <input v-model="userInput" @keyup.enter="askGemini" type="text" placeholder="ä¾‹ï¼šå¹«æˆ‘åˆ†æç¾åœ¨çš„è²·é»..." class="flex-1 bg-black border border-gray-700 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-blue-500">
                    <button @click="askGemini" class="bg-blue-600 p-2 rounded-full hover:bg-blue-500">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
            <button v-else @click="chatOpen = true" class="w-16 h-16 bg-blue-600 rounded-full shadow-2xl flex items-center justify-center text-3xl hover:scale-110 transition-transform animate__animated animate__bounceIn">ğŸ¤–</button>
        </div>
        
        <div v-if="selectedStock" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm" @click.self="selectedStock = null">
            <div class="bg-gray-900 w-full max-w-5xl rounded-3xl overflow-hidden border border-gray-700 shadow-2xl">
                <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                    <h2 class="text-2xl font-black">{{ selectedStock.symbol }} æŠ€è¡“åˆ†æ</h2>
                    <button @click="selectedStock = null" class="text-3xl">&times;</button>
                </div>
                <div class="h-[500px] w-full" id="tv-chart"></div>
            </div>
        </div>
    </div>

    <script type="importmap"> { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } } </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const { createApp, nextTick } = Vue;
        const STOCK_API = 'd65qv59r01qiish0oeo0d65qv59r01qiish0oeog';

        createApp({
            data() {
                return {
                    countdown: 60,
                    stocks: [
                        { symbol: 'AAPL', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'MSFT', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'GOOGL', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'AMZN', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'NVDA', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'META', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'TSLA', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'AVGO', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'TSM', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false },
                        { symbol: 'ORCL', price: '0', change: 0, distLow: 0, pos: 0, isBuy: false }
                    ],
                    chatOpen: false,
                    userInput: '',
                    chatHistory: [{ role: 'model', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI æŠ•è³‡åŠ©æ‰‹ã€‚æˆ‘å·²åŒæ­¥ä½ çš„ 10 æª”ç§‘æŠ€è‚¡æ•¸æ“šï¼Œæƒ³å•å“ªä¸€æª”çš„åˆ†æï¼Ÿ' }],
                    isTyping: false,
                    apiKey: 'AIzaSyDjfMSJ62iLL8eBV72Bu-7zCYiaeGuOZnw', // ä½ æä¾›çš„ Key
                    selectedStock: null
                }
            },
            mounted() {
                this.updateData();
                setInterval(() => {
                    if (this.countdown <= 1) { this.updateData(); this.countdown = 60; }
                    else { this.countdown--; }
                }, 1000);
            },
            methods: {
                async updateData() {
                    for (let s of this.stocks) {
                        try {
                            const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${s.symbol}&token=${STOCK_API}`);
                            const d = await res.json();
                            const mRes = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${s.symbol}&metric=all&token=${STOCK_API}`);
                            const m = await mRes.json();
                            
                            s.price = d.c.toFixed(2);
                            s.change = d.dp.toFixed(2);
                            s.distLow = (((d.c - m.metric['52WeekLow']) / m.metric['52WeekLow']) * 100).toFixed(1);
                            s.isBuy = s.distLow < 5;
                        } catch (e) { console.error(e); }
                    }
                },
                async askGemini() {
                    if (!this.userInput) return;
                    const text = this.userInput;
                    this.chatHistory.push({ role: 'user', text });
                    this.userInput = '';
                    this.isTyping = true;

                    const context = this.stocks.map(s => `${s.symbol}: $${s.price} (${s.change}%, è·ä½é»${s.distLow}%)`).join(', ');
                    const prompt = `ä½ æ˜¯ä¸€å€‹è³‡æ·±ç¾è‚¡åˆ†æå¸«ã€‚ç›®å‰æ•¸æ“šï¼š[${context}]ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼š${text}`;

                    try {
                        const genAI = new GoogleGenerativeAI(this.apiKey);
                        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                        const result = await model.generateContent(prompt);
                        this.chatHistory.push({ role: 'model', text: result.response.text().replace(/\n/g, '<br>') });
                    } catch (e) {
                        this.chatHistory.push({ role: 'model', text: 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key ç‹€æ…‹ã€‚' });
                    } finally {
                        this.isTyping = false;
                        nextTick(() => { const b = document.getElementById('chatbox'); b.scrollTop = b.scrollHeight; });
                    }
                },
                async openModal(s) {
                    this.selectedStock = s;
                    await nextTick();
                    new TradingView.widget({
                        "autosize": true, "symbol": s.symbol, "interval": "D", "theme": "dark", "style": "1", "locale": "zh_TW", "container_id": "tv-chart"
                    });
                }
            }
        }).mount('#app');
    </script>
    <script src="https://s3.tradingview.com/tv.js"></script>
</body>
</html>
